#OAuth

## 1. ```redirect_uri``` parameter

- Open Redirect
```https://oauth-server.com/auth?redirect_uri=https://attacker-site.com```
- Host Header Injection
- Flawed ```redirect_uri``` validation
  -- Host is validated, path isn't
  -- Weak regex:
  ```https://oauth-server.com/auth?redirect_uri=https://client-app.com.attacker-site.com```
  -- Discrepancies between the parsing of the URI by the different components:
  ```https://default-host.com &@foo.evil-user.net#@bar.evil-user.net/```
  -- Server-side parameter pollution:
  ```https://oauth-server.com/auth?redirect_uri=https://client-app.com&redirect_uri=https://attacker-site.com```
  -- Redirect URI beginning with localhost:
  ```https://oauth-server.com/auth?redirect_uri=https://localhost.attacker-site.com```
- Stealing codes and access token via a proxy page:
```https://oauth-server.com/auth?redirect_uri=https://client-app.com/oauth/callback/../../example/path?redirect=https://attacker-site.com```

## 2. ```state``` parameter

- The OAuth flow is vulnerable to CSRF if the ```state``` parameter:
  - missing
  - a static value that never changes
  - present but not validated
  - can reuse
- Exploit: start OAuth flow -> intercept last request -> send this URL to the logged-in victim -> log in to the victim's account

## 3. Code and access token flaws

- can reuse
- can brute force
- code or token for application X is valid for application Y
- Access token passed in request body:
  - Create a app and register for an OAuth framework
  - Use this app for generating a access token for a victim's account 
  - Pass the generated access token to vulnerable request -> access to the victim's account
- Convert authorization code grant to implicit grant -> modify ```response_type``` value to "token"

## 4. Assignment of accounts based on email address

- If the application dose not require email vertification on account creation:
  - Victim register or login with OAuth of victim@gmail.com
  - Attacker register a new account with password-based login (victim@gmail.com/new_password)
  - Attacker login with the new account -> access to the victim's account
  
## 5. Client secrets leakage

- Check JavaScript
- Check referer header in the requests for code or access token leakage

## Reference

- https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1
- https://medium.com/@apkash8/oauth-and-security-7fddce2e1dc5
- https://xploitprotocol.medium.com/exploiting-oauth-2-0-authorization-code-grants-379798888893
- https://0xn3va.gitbook.io/cheat-sheets/web-application/oauth-2.0-vulnerabilities
- https://six2dez.gitbook.io/pentest-book/enumeration/webservices/oauth
- https://twitter.com/hackerscrolls/status/1269266750467649538
